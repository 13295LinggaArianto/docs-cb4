<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="n1ql_application_continuity">
    <title>N1QL Application Continuity</title><shortdesc>In Couchbase Server 5.0, N1QL introduced multiple performance enhancements enabled by a
        new internal API between the Query and Index services, which guarantees the accuracy of
        query results between multiple versions of services while nodes are being upgraded.</shortdesc>
    <body>
        <note>Before doing any upgrade, you must have all the required RBAC roles of every Data,
            Index, and Query service involved in the upgrade. For details about RBAC permissions,
            see <xref
                href="../security/concepts-rba-for-apps.dita#rbac_for_users_roles_and_privileges"
            />.</note>
        <note>This page refers to the new 5.0 API as "API-2" and the pre-5.0 API as "API-1".</note>
        <p>API-1 and API-2 is used only between Index nodes and Query nodes since the Data nodes
            don't use any API and are unaffected by the Index and Query versions.</p>
        <p>While Index 4.x supports API-1 only, Index 5.0 supports both API-1 and API-2, so there is
            no impact.<note>As Index nodes and Query nodes are being upgraded, even after all the
                Query nodes are upgraded, they will continue using API-1 until all the Index nodes
                are upgraded.</note></p>
        <p>While upgrading larger Couchbase cluster deployments, the cluster may be in a state of
            running different Couchbase versions of each service; so N1QL Application Continuity
            supports various upgrade scenarios, such as:<ul id="ul_nx3_pgq_hbb">
                <li><b>Scenario 1 (D → I → Q)</b>: Upgrade in the order of 1) Data nodes, 2) Index
                    nodes, 3) Query nodes.</li>
                <li><b>Scenario 2 (D → Q → I)</b>: Upgrade in the order of 1) Data nodes, 2) Query
                    nodes, 3) Index nodes.</li>
                <li><b>Scenario 3 (I → Q → D)</b>: Upgrade in the order of 1) Index nodes, 2) Query
                    nodes, 3) Data nodes.</li>
                <li><b>Scenario 4 (I + Q + D)</b>: Upgrade with Index+Query or Index+Query+Data on
                    one node.</li>
            </ul></p>
        <p>Consider the following example cluster of 4.5 nodes that applies to all 4.x
                versions:<image href="images/application-continuity_Scenario1_Step0.png"
                id="image_p53_ykq_hbb"/></p>
        <section id="section_zwv_fjq_hbb">
            <title>Scenario 1 (D → I → Q)</title>
            <p>If you want to use the most common and straight-forward order of upgrading, use the
                following order: <table frame="none" rowsep="0" colsep="0" id="table_v3k_kjq_hbb">
                    <tgroup cols="2" align="left">
                        <colspec colname="c1" colnum="1" colwidth="1*"/>
                        <colspec colname="c2" colnum="2" colwidth="4*"/>
                        <tbody>
                            <row>
                                <entry>1) Data Service nodes<p>2) Index Service nodes</p><p>3) Query
                                        Service nodes</p></entry>
                                <entry><image
                                        href="images/application-continuity_Scenario1_overview.png"
                                        id="image_o3p_blq_hbb"/></entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table><b>Step 1: Upgrade the Data Service nodes from 4.x to 5.0</b><ul
                    id="ul_zyk_pjq_hbb">
                    <li>Follow the current rolling upgrade procedure for all data nodes,
                        one-by-one.</li>
                    <li>The applications directly fetching the data will continue without
                        interruption.</li>
                    <li>Index will continue to get DCP stream and will keep the index up to
                        date.</li>
                    <li>Query will use the index and data services as they did before 5.0.</li>
                    <li>Applications that use query and index continue uninterrupted.</li>
                </ul><b>Step 2: Upgrade the Index Service nodes from 4.x to 5.0</b><ul
                    id="ul_hnf_1kq_hbb">
                    <li>As you upgrade each index, the indexing client within the Query node will
                        continue to use API-1 to interact with the Index nodes. </li>
                    <li/>
                </ul></p>
        </section>
    </body>
</topic>
