<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  </head>
 
<body>
<article class="doc">
<h1>Cluster Deployment Tutorial</h1>
<div class="paragraph">
<p>This tutorial walks you through the steps to deploy a 3-nodes cluster
and load data into the cluster.</p>
</div>
<div class="paragraph">
<p><strong>Prerequisites</strong> Before proceeding to perform the steps in this tutorial,
ensure that you’ve prepared your Kubernetes cluster to run Couchbase
pods. See <a href="prerequisiteAndSetup.adoc">Prerequisites and Setup</a> for
details. The tutorial also requires the following artifacts that are
bundled with the Couchbase Operator package: - <code>create-user.yaml</code> spec
to create secrets for the Couchbase RBAC user. -
<code>pillowfight-data-loader.yaml</code> job to load data into your cluster.</p>
</div>
<div class="exampleblock result">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Create a Couchbase Cluster</strong></p>
<div class="paragraph">
<p>On Kubernetes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[source,console]
----
$ kubectl apply -f  https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cluster.yaml
couchbasecluster "cb-example" created
----</pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[source,console]
----
$ oc apply -f  https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cluster.yaml
couchbasecluster "cb-example" created
----</pre>
</div>
</div>
</li>
<li>
<p><strong>Create a Couchbase RBAC user</strong></p>
<div class="paragraph">
<p>This tutorial will be loading data in Couchbase and hence requires a
Couchbase RBAC user to be created. RBAC users can be created by directly
using the CLI, or as a job within the Kubernetes cluster. See
<a href="couchbaseCliGuide.adoc">Accessing the Couchbase CLI</a> for details.</p>
</div>
<div class="paragraph">
<p><strong>Option 1: Create a default user using the CLI</strong><br/>
Use the <code>describe</code> command to get the Web Console port:<br/>
On Kubernetes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl describe cbc cb-example |  grep "Admin Console Port:"
   Admin Console Port:      32486</pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc describe cbc cb-example |  grep "Admin Console Port:"
   Admin Console Port:      32486</pre>
</div>
</div>
<div class="paragraph">
<p>Create a Couchbase RBAC user by running the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./couchbase-cli user-manage -c 192.168.99.100:32486 -u Administrator -p password --rbac-username default --rbac-password password --roles admin --auth-domain local --set
SUCCESS: RBAC user set</pre>
</div>
</div>
<div class="paragraph">
<p>(You can skip to the next step: Loading data)<br/></p>
</div>
<div class="paragraph">
<p><strong>Option 2: Create a default user with Kubernetes job</strong><br/>
Just as the admin user has a secret, the RBAC user also requires its own secret. Create a secret for the RBAC user by running the following
  commands:<br/></p>
</div>
<div class="literalblock">
<div class="content">
<pre># secret for user named 'default'
$ echo -n "default" | base64
ZGVmYXVsdA==
$ echo -n "password" | base64
cGFzc3dvcmQ=</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ echo 'apiVersion: v1
kind: Secret
metadata:
  name: cb-user-auth
type: Opaque
data:
  default_user: ZGVmYXVsdA==
  default_password: cGFzc3dvcmQ=' &gt;  cb-user-auth-secret.yaml</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl create -f  cb-user-auth-secret.yaml
secret "cb-user-auth" created</pre>
</div>
</div>
<div class="paragraph">
<p>Now, use the RBAC user’s secret to securely create a Couchbase RBAC user using a Kubernetes/OpenShift job:<br/>
On Kubernetes:<br/></p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cli-create-user.yaml
job "create-user" created</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl get job
NAME          DESIRED   SUCCESSFUL   AGE
create-user   1         1            4s</pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:<br/></p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cli-create-user.yaml
job "create-user" created</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get job
NAME          DESIRED   SUCCESSFUL   AGE
create-user   1         1            4s</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are not using the default namespace, you must download and update the <code>couchbase-cli-create-user.yaml</code> file to reflect your namespace.<br/>
For example, if your namespace is <code>myproject</code>, edit the <code>command</code> field in the YAML file to replace <code>cb-example-0000.cb-example.default.svc</code> with <code>cb-example-0000.cb-example.myproject.svc</code>.
The updated field will now look like the following snippet.<br/>
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre> command: ["/bin/sh", "-c", "/couchbase-cli-secure user-manage
                     -c cb-example-0000.cb-example.myproject:wq
.svc
                     -u {auth.admin.username}
                     -p {auth.admin.password}
                     --rbac-username {auth.users.default_user}
                     --rbac-password {auth.users.default_password}
                     --roles admin --auth-domain local --set"]</pre>
</div>
</div>
<div class="paragraph">
<p>The name of the secret and its keys are very important as the sample <code>create-user</code> spec mounts the secrets into a volume.<br/></p>
</div>
<div class="literalblock">
<div class="content">
<pre>----
# https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cli-create-user.yaml
---
apiVersion: batch/v1
kind: Job
metadata:
  name: create-user
spec:
...
      volumes:
        - name: cb-admin
          secret:
            secretName: cb-example-auth
        - name: cb-users
          secret:
            secretName: cb-user-auth
----</pre>
</div>
</div>
</li>
<li>
<p><strong>Loading data</strong></p>
<div class="paragraph">
<p>Use the sample <code>pillowfight</code> job to load items into your cluster. The
following spec loads 10k items into the Couchbase cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
---
apiVersion: batch/v1
kind: Job
metadata:
  name: pillowfight
spec:
  template:
    metadata:
      name: pillowfight
    spec:
      containers:
      - name: pillowfight
        image: sequoiatools/pillowfight:v5.0.1
        command: ["cbc-pillowfight",
                  "-U", "couchbase://cb-example-0000.cb-example.default.svc/default?select_bucket=true",
                  "-I", "10000", "-B", "1000", "-c", "10", "-t", "1", "-P", "password"]
      restartPolicy: Never</code></pre>
</div>
</div>
<div class="paragraph">
<p>To deploy the <code>pillowfight</code> data loader, run the following command: On
Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/pillowfight-data-loader.yaml
job "pillowfight" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/pillowfight-data-loader.yaml
job "pillowfight" created</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are not using the default namespace, you must download and update the <code>pillowfight-data-loader.yaml</code> file to reflect your namespace.
For example, if your namespace is <code>myproject</code>, edit the <code>command</code> field in the YAML file to replace <code>cb-example-0000.cb-example.default.svc</code> with <code>cb-example-0000.cb-example.myproject.svc</code>.
The updated field will now look like the following snippet.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">---
command: ["cbc-pillowfight",
          "-U", "couchbase://cb-example-0000.cb-example.myproject.svc/default?select_bucket=true",
          "-I", "10000", "-B", "1000", "-c", "10", "-t", "1", "-P", "password"]
---</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once the command completes, you should have 10k items loaded in your cluster.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="adminConsoleAccess.adoc">Accessing the Couchbase Web Console</a> for
information about how to access the Web Console.</p>
</div>
</article>
 </body>
</html>
