<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  </head>
 
 <body>
<article class="doc">
<h1>Logs and Troubleshooting</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section provides information on how to diagnose and troubleshoot
problems with the Couchbase Operator or your deployment.</p>
</div>
<div class="paragraph">
<p>When troubleshooting the Couchbase Operator, it is important to rule out
Kubernetes itself as the root cause of the problem you are experiencing.
See the Kubernetes
<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/troubleshooting/">Troubleshooting
Guide</a> for tips on debugging applications within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>The following references are also helpful when troubleshooting: *
<a href="clusterStatusGuide.adoc">Cluster Status and Conditions</a> *
<a href="conditionsAndEvents.adoc">Understanding Conditions and Events</a> *
<a href="listAndDescribe.adoc">Listing And Describing Resources</a> *
<a href="nodeRecovery.adoc">Node Recovery</a> * <a href="operatorConfig.adoc">Operator
Configuration</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="full-deployment-logs"><a class="anchor" href="#full-deployment-logs"></a>Full Deployment Logs</h3>
<div class="paragraph">
<p>To get logs of the Operator along with your entire Kubernetes deployment
(nodes, pods, servicesâ€¦), run the following script:
<a href="https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-kubernetes-support.sh">cb_k8s_support.sh</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">wget https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-kubernetes-support.sh
chmod +x couchbase-kubernetes-support.sh
./couchbase-kubernetes-support.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>This scripts gathers information about your Kubernetes deployment and
creates an archive within your current working directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&lt;cwd&gt;/cb-k8s-support-01182018-14_00_18.tgz</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script runs <code>kubectl top pod</code> to gather pod metrics such as CPU and
memory. By default, these metrics are empty unless you have <code>heapster</code>
deployed within your Kubernetes cluster. To deploy <code>heapster</code> for
gathering pod metrics, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone https://github.com/kubernetes/heapster.git
cd heapster
kubectl create -f deploy/kube-config/influxdb/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run the support script, <code>cb_k8s_support.sh</code>, again to generate logs
which include pod metrics.</p>
</div>
</div>
<div class="sect2">
<h3 id="operator-logs"><a class="anchor" href="#operator-logs"></a>Operator Logs</h3>
<div class="paragraph">
<p>The Couchbase Operator generates logs that can help troubleshoot your
deployment. Using <code>kubectl</code> or <code>oc</code>, you can choose to print the
Operator logs to stdout. On Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># Get name of operator pod
$ kubectl get po -lname=couchbase-operator
NAME                                  READY     STATUS    RESTARTS   AGE
couchbase-operator-1917615544-h20bm   1/1       Running   0          20h

# Get logs
$ kubectl logs couchbase-operator-1917615544-h20bm
time="2018-01-23T22:56:34Z" level=info msg="Obtaining resource lock" module=main
time="2018-01-23T22:56:34Z" level=info msg="Starting event recorder" module=main
time="2018-01-23T22:56:34Z" level=info msg="Attempting to be elected the couchbase-operator leader" module=main
time="2018-01-23T22:56:51Z" level=info msg="I'm the leader, attempt to start the operator" module=main
time="2018-01-23T22:56:51Z" level=info msg="Creating the couchbase-operator controller" module=main</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># Get name of operator pod
$ oc get po -lname=couchbase-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Watch for the following messages which indicate that the Operator is
unable to reconcile your cluster into a desired state: * Logs with
level=error * Operator is unable to get cluster state after N retries</p>
</div>
</div>
<div class="sect2">
<h3 id="getting-couchbase-server-logs"><a class="anchor" href="#getting-couchbase-server-logs"></a>Getting Couchbase Server Logs</h3>
<div class="paragraph">
<p>The easiest way to get <code>cbcollect</code> logs is to access the Couchbase Web
Console and click the <strong>Collect Logs</strong> button in the Logs tab. You can
also deploy a job within Kubernetes to trigger log collection: On
Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cli-collect-logs.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cli-collect-logs.yaml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are not using the default namespace, you must download and update the <code>couchbase-cli-collect-logs.yaml</code> file to reflect your namespace.
For example, if your namespace is <code>myproject</code>, edit the <code>command</code> field in the YAML file to replace <code>cb-example-0000.cb-example.default.svc</code> with <code>cb-example-0000.cb-example.myproject.svc</code>.
The updated field will now look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">---
command: ["/bin/sh", "-c", "couchbase-cli-secure collect-logs-start
                              -c cb-example-0000.cb-example.myproject.svc
                              -u {auth.admin.username}
                              -p {auth.admin.password}
                              --all-nodes"]
---</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once log collection has completed, check the Couchbase Web Console &gt;
Logs tab &gt; Collection Info for the path to the corresponding zip file
for each node in the cluster. You can then run a command like the
following for each node in the cluster to collect their logs.
On Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl cp &lt;namespace&gt;/&lt;pod_name&gt;:&lt;path_to_logs&gt; -c couchbase-server ./logs.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc cp &lt;namespace&gt;/&lt;pod_name&gt;:&lt;path_to_logs&gt; -c couchbase-server ./logs.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example command to collect the logs for node
<code>cb-example-0000</code>.
On Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl cp default/cb-example-0000:/opt/couchbase/var/lib/couchbase/tmp/collectinfo-2017-09-28T175135-ns_1@127.0.0.1.zip -c couchbase-server ./logs.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc cp default/cb-example-0000:/opt/couchbase/var/lib/couchbase/tmp/collectinfo-2017-09-28T175135-ns_1@127.0.0.1.zip -c couchbase-server ./logs.zip</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="see-also"><a class="anchor" href="#see-also"></a>See Also</h3>
<div class="paragraph">
<p>Refer to the
<a href="https://developer.couchbase.com/documentation/server/current/troubleshooting/troubleshooting-intro.html">Couchbase
Server Troubleshooting</a> guide for additional information about reporting
issues.</p>
</div>
</div>
</article>
</body>
</html>
