<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  </head>
<body>
<article class="doc">
<h1>Listing And Describing Resources</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When a Couchbase cluster is deployed, additional Kubernetes resources
such as pods and services are created by the Operator to facilitate its
deployment. All resources originating from the Couchbase Operator are
labeled in order to make it easy to list and describe resources
belonging to a specific cluster. The following sections list and explain
the resources created by the Operator when the cluster is running.</p>
</div>
<div class="paragraph">
<p>Note that each of the commands below use <code>kubectl</code> with the default
namespace <code>kubectl -n default &#8230;&#8203;</code> when using Kubernetes. If you’ve
deployed your cluster using a different namespace, you will need to
explicitly provide the namespace where your cluster is deployed.
Similarly, if you are using OpenShift, the commands <code>oc</code> use the default
namespace <code>oc -n default &#8230;&#8203;</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="operator-deployment"><a class="anchor" href="#operator-deployment"></a>Operator Deployment</h3>
<div class="paragraph">
<p>The Operator is started as a deployment resource. The name of the object
will match the name provided in your deployment specification. (See
<a href="prerequisiteAndSetup.adoc">Prerequisites and Setup</a> for details.) The
Operator deployment can be listed and described as follows: On
Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get deployments couchbase-operator
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
couchbase-operator   1         1         1            1           27m

$ kubectl describe deployments couchbase-operator
Name:           couchbase-operator
Namespace:      default
Labels:         name=couchbase-operator
Replicas:       1 desired | 1 updated | 1 total | 1 available | 0 unavailable
Pod Template:
  Labels:   name=couchbase-operator
  Containers:
   couchbase-operator:
    Image:  couchbase/couchbase-operator:v1
    Port:   8080/TCP
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get deployments couchbase-operator
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
couchbase-operator   1         1         1            1           27m

$ oc describe deployments couchbase-operator
Name:           couchbase-operator
Namespace:      default
Labels:         name=couchbase-operator
Replicas:       1 desired | 1 updated | 1 total | 1 available | 0 unavailable
Pod Template:
  Labels:   name=couchbase-operator
  Containers:
   couchbase-operator:
    Image:  couchbase/couchbase-operator:v1
    Port:   8080/TCP
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the deployment resource manages a ReplicaSet, which means
it’s important to check that the desired number of replicas match the
total number of available replicas when describing the Operator
deployment.</p>
</div>
<div class="paragraph">
<p>Additional information about the ReplicaSets and pods created by the
Operator deployment can be described using the deployment name as a
label selector. On Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># replicasets created by couchbase-operator deployment
$ kubectl describe rs -lname=couchbase-operator

# pods created by the deployments replicaset
$ kubectl describe pods -lname=couchbase-operator
Name:       couchbase-operator-1917615544-8kgw9
Status:     Running
IP:     172.17.0.3
Created By: ReplicaSet/couchbase-operator-1917615544
Containers:
  couchbase-operator:
    Image:      couchbase/couchbase-operator:v1
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># replicasets created by couchbase-operator deployment
$ oc describe rs -lname=couchbase-operator

# pods created by the deployments replicaset
$ oc describe pods -lname=couchbase-operator
Name:       couchbase-operator-1917615544-8kgw9
Status:     Running
IP:     172.17.0.3
Created By: ReplicaSet/couchbase-operator-1917615544
Containers:
  couchbase-operator:
    Image:      couchbase/couchbase-operator:v1
    ...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="server-pods"><a class="anchor" href="#server-pods"></a>Server Pods</h3>
<div class="paragraph">
<p>Couchbase pods can be listed using the <code>-lapp=couchbase</code> label. On
Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get po -l app=couchbase
NAME                  READY     STATUS    RESTARTS   AGE
cb-development-0000   1/1       Running   0          1h
cb-development-0001   1/1       Running   0          1h
cb-production-0000    1/1       Running   0          1h
cb-production-0001    1/1       Running   0          1h</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get po -l app=couchbase</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pods are also labeled by cluster and according to Couchbase service,
which makes it possible to get only the pods providing a specific
service for a specific cluster. For example, the following command gets
only the pods providing the query service on the <code>cb-development</code>
cluster. On Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># query pods on dev deployment
$ kubectl get po -l couchbase_cluster=cb-development,couchbase_service_query
NAME                  READY     STATUS    RESTARTS   AGE
cb-development-0000   1/1       Running   0          1h
cb-development-0001   1/1       Running   0          1h</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># query pods on dev deployment
$ oc get po -l couchbase_cluster=cb-development,couchbase_service_query</code></pre>
</div>
</div>
<div class="paragraph">
<p>After listing the pods, additional information can be collecting using
<code>kubectl describe</code> on Kubernetes as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl describe po cb-development-0000
Name:       cb-development-0000
Namespace:  default
Node:       minikube/192.168.99.100
Start Time: Tue, 23 Jan 2018 07:49:38 -0700
Labels:     app=couchbase
        couchbase_cluster=cb-development
...
Containers:
  couchbase-server:
    Container ID:   docker://6b7aeb66cb540c6904b8e514776c180f7fbbea25656e6175972c408042db5713
    Image:      couchbase/server:enterprise-5.0.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc describe po cb-development-0000</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="services"><a class="anchor" href="#services"></a>Services</h3>
<div class="paragraph">
<p>Services are created to facilitate both pod to pod communication and
connections from external clients to the internal cluster. The former is
established using a headless ClusterIP service, and the latter via the
NodePort service. You can read more about the Kubernetes services
<a href="https://kubernetes.io/docs/concepts/services-networking/service/">here</a>.
When listing the services, the name of the ClusterIP service will match
the name provided in the CouchbaseCluster spec. The NodePort service is
also named after the CouchbaseCluster name, except with a `-ui' suffix.</p>
</div>
<div class="paragraph">
<p>Services belonging to the Operator can be listed as follows: On
Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># all services managed by the operator
$ kubectl get service -lapp=couchbase
NAME                CLUSTER-IP   EXTERNAL-IP   PORT(S)                          AGE
cb-development      None         &lt;none&gt;        8091/TCP,18091/TCP               2m
cb-development-ui   10.0.0.7     &lt;nodes&gt;       8091:31822/TCP,18091:30155/TCP   2m
cb-production       None         &lt;none&gt;        8091/TCP,18091/TCP               1m
cb-production-ui    10.0.0.216   &lt;nodes&gt;       8091:30139/TCP,18091:30461/TCP   1m

# only services used by cb-production cluster
$ kubectl get service -lcouchbase_cluster=cb-production
NAME               CLUSTER-IP   EXTERNAL-IP   PORT(S)                          AGE
cb-production      None         &lt;none&gt;        8091/TCP,18091/TCP               2m
cb-production-ui   10.0.0.216   &lt;nodes&gt;       8091:30139/TCP,18091:30461/TCP   2m</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift, use the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># all services managed by the operator
$ oc get service -lapp=couchbase
NAME                CLUSTER-IP   EXTERNAL-IP   PORT(S)                          AGE
cb-development      None         &lt;none&gt;        8091/TCP,18091/TCP               2m
cb-development-ui   10.0.0.7     &lt;nodes&gt;       8091:31822/TCP,18091:30155/TCP   2m
cb-production       None         &lt;none&gt;        8091/TCP,18091/TCP               1m
cb-production-ui    10.0.0.216   &lt;nodes&gt;       8091:30139/TCP,18091:30461/TCP   1m

# only services used by cb-production cluster
$ oc get service -lcouchbase_cluster=cb-production
NAME               CLUSTER-IP   EXTERNAL-IP   PORT(S)                          AGE
cb-production      None         &lt;none&gt;        8091/TCP,18091/TCP               2m
cb-production-ui   10.0.0.216   &lt;nodes&gt;       8091:30139/TCP,18091:30461/TCP   2m</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="describing-services"><a class="anchor" href="#describing-services"></a>Describing services</h4>
<div class="paragraph">
<p>After listing the services, additional information about ports and
endpoints can be gathered on Kubernetes using <code>kubectl describe</code> as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl describe service cb-production

Name:           cb-production
Namespace:      default
Labels:         app=couchbase
            couchbase_cluster=cb-production
Annotations:        service.alpha.kubernetes.io/tolerate-unready-endpoints=true
Selector:       app=couchbase,couchbase_cluster=cb-production
Type:           ClusterIP
IP:         None
Port:           cb-admin    8091/TCP
Endpoints:      172.17.0.10:8091,172.17.0.9:8091
Port:           cb-admin-ssl    18091/TCP
Endpoints:      172.17.0.10:18091,172.17.0.9:18091
Session Affinity:   None
Events:         &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc describe service cb-production</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>You should expect that all pods within a cluster also exist as an
endpoint to each service.</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="listing-custom-resources"><a class="anchor" href="#listing-custom-resources"></a>Listing Custom Resources</h3>
<div class="paragraph">
<p>Custom resources are extensions of the Kubernetes API. The Couchbase
Operator creates custom resources of type <code>CouchbaseCluster</code> for each
cluster being deployed. Custom resources can be listed and described
using <code>kubectl</code> just as other built-in resources. On Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get couchbasecluster
NAME             KIND
cb-development   CouchbaseCluster.v1beta1.couchbase.database.couchbase.com
cb-production    CouchbaseCluster.v1beta1.couchbase.database.couchbase.com

$ kubectl describe couchbasecluster cb-production
Name:       cb-production
Namespace:  default
Labels:     &lt;none&gt;
Annotations:    kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"couchbase.database.couchbase.com/v1beta1","kind":"CouchbaseCluster","metadata":{"annotations":{},"name":"cb-production","namespace":"def...
API Version:    couchbase.database.couchbase.com/v1beta1
Kind:       CouchbaseCluster
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get couchbasecluster
NAME             KIND
cb-development   CouchbaseCluster.v1beta1.couchbase.database.couchbase.com
cb-production    CouchbaseCluster.v1beta1.couchbase.database.couchbase.com

$ oc describe couchbasecluster cb-production
Name:       cb-production
Namespace:  default
Labels:     &lt;none&gt;
Annotations:    kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"couchbase.database.couchbase.com/v1beta1","kind":"CouchbaseCluster","metadata":{"annotations":{},"name":"cb-production","namespace":"def...
API Version:    couchbase.database.couchbase.com/v1beta1
Kind:       CouchbaseCluster
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Describing the cluster resource returns the deployed specification and
its active status. For more information about the response returned from
the describe command, see <a href="clusterStatusGuide.adoc">Cluster Status
Guide</a>.</p>
</div>
</div>
</article>
</body>
</html>
